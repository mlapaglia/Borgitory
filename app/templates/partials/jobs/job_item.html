{# Job item template for rendering individual job cards #}
<div class="border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
    <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="toggleJobDetails({{ job.id }})">
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-3">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {{ status_class }}">
                        {{ status_icon }} {{ job.status.title() }}
                    </span>
                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                        {{ job_title }}
                    </span>
                </div>
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-x-4">
                    <span>Started: {{ started_at }}</span>
                    {% if job.finished_at %}
                        <span>Finished: {{ finished_at }}</span>
                    {% endif %}
                    {% if job.error %}
                        <span class="text-red-600">Error: {{ job.error }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex-shrink-0 flex items-center space-x-2">
                <span class="text-sm text-gray-500 dark:text-gray-400">#{{ job.id }}</span>
                <svg id="chevron-{{ job.id }}" class="w-4 h-4 text-gray-400 dark:text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" {% if expand_details %}style="transform: rotate(180deg);"{% endif %}>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
    </div>
    <div id="job-details-{{ job.id }}" class="{% if expand_details %}border-t dark:border-gray-600 bg-gray-50 dark:bg-gray-700 p-4{% else %}hidden border-t dark:border-gray-600 bg-gray-50 dark:bg-gray-700 p-4{% endif %}">
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="font-medium text-gray-700 dark:text-gray-300">Type:</span>
                    <span class="ml-2 text-gray-900 dark:text-gray-100">{{ job.type }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700 dark:text-gray-300">Repository:</span>
                    <span class="ml-2 text-gray-900 dark:text-gray-100">{{ repository_name }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700 dark:text-gray-300">Started:</span>
                    <span class="ml-2 text-gray-900 dark:text-gray-100">{{ started_at }}</span>
                </div>
                <div>
                    <span class="font-medium text-gray-700 dark:text-gray-300">Finished:</span>
                    <span class="ml-2 text-gray-900 dark:text-gray-100">{% if job.finished_at %}{{ finished_at }}{% else %}N/A{% endif %}</span>
                </div>
            </div>

            {% if is_composite %}
                {# Composite job with tasks #}
                <div class="mt-4">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">Tasks:</h4>
                    <div class="space-y-2">
                        {% for task in sorted_tasks %}
                            {# Task status styling #}
                            {% if task.status == "completed" %}
                                {% set task_status_class = "bg-green-100 text-green-800" %}
                                {% set task_status_icon = "✓" %}
                            {% elif task.status == "failed" %}
                                {% set task_status_class = "bg-red-100 text-red-800" %}
                                {% set task_status_icon = "✗" %}
                            {% elif task.status == "running" %}
                                {% set task_status_class = "bg-blue-100 text-blue-800" %}
                                {% set task_status_icon = "⟳" %}
                            {% elif task.status == "skipped" %}
                                {% set task_status_class = "bg-yellow-100 text-yellow-800" %}
                                {% set task_status_icon = "⤴" %}
                            {% else %}
                                {% set task_status_class = "bg-gray-100 text-gray-800" %}
                                {% set task_status_icon = "◦" %}
                            {% endif %}
                            
                            {# Task timing #}
                            {% set task_started = task.started_at.strftime("%H:%M:%S") if task.started_at else "N/A" %}
                            {% set task_finished = task.completed_at.strftime("%H:%M:%S") if task.completed_at else "N/A" %}
                            
                            {# Task duration #}
                            {% set task_duration = "" %}
                            {% if task.started_at and task.completed_at %}
                                {% set duration = task.completed_at - task.started_at %}
                                {% set task_duration = "({:.1f}s)".format(duration.total_seconds()) %}
                            {% endif %}
                            
                            <div class="border dark:border-gray-600 rounded p-3 bg-white dark:bg-gray-600">
                                <div class="flex items-center justify-between cursor-pointer" onclick="toggleTaskDetails({{ job.id }}, {{ task.task_order }})">
                                    <div class="flex items-center space-x-3">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {{ task_status_class }}">
                                            {{ task_status_icon }} {{ task.status.title() }}
                                        </span>
                                        <span class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ task.task_name }}</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ task_duration }}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-500 dark:text-gray-400">{{ task_started }} - {{ task_finished }}</span>
                                        <svg id="task-chevron-{{ job.id }}-{{ task.task_order }}" class="w-3 h-3 text-gray-400 dark:text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                
                                {# Task output section #}
                                {% if task.output and task.output.strip() %}
                                    {% set escaped_output = task.output.strip() | e %}
                                    <div id="task-details-{{ job.id }}-{{ task.task_order }}" class="hidden mt-3 pt-3 border-t dark:border-gray-500">
                                        <div class="flex items-center justify-between mb-2">
                                            <h5 class="text-xs font-medium text-gray-700 dark:text-gray-300">Output:</h5>
                                            <button onclick="copyTaskOutput({{ job.id }}, {{ task.task_order }})" class="text-xs text-blue-600 hover:text-blue-800">Copy</button>
                                        </div>
                                        <div class="bg-gray-900 text-green-400 p-3 rounded text-xs font-mono whitespace-pre-wrap overflow-x-auto max-h-60 overflow-y-auto" id="task-output-{{ job.id }}-{{ task.task_order }}">{{ escaped_output }}</div>
                                        {% if task.error %}
                                            <div class="mt-2 text-xs text-red-600">Error: {{ task.error }}</div>
                                        {% endif %}
                                    </div>
                                {% elif task.error %}
                                    <div id="task-details-{{ job.id }}-{{ task.task_order }}" class="hidden mt-3 pt-3 border-t dark:border-gray-500">
                                        <div class="text-xs text-red-600">Error: {{ task.error }}</div>
                                    </div>
                                {% else %}
                                    {# Check if this task is currently running and show streaming output #}
                                    {% if task.status == "running" %}
                                        <div id="task-details-{{ job.id }}-{{ task.task_order }}" class="hidden mt-3 pt-3 border-t dark:border-gray-500">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="text-xs font-medium text-gray-700 dark:text-gray-300">Live Output:</h5>
                                                <div class="flex items-center">
                                                    <div class="animate-pulse w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                                    <span class="text-xs text-green-600">Streaming</span>
                                                </div>
                                            </div>
                                            <div class="bg-gray-900 text-green-400 p-3 rounded text-xs font-mono whitespace-pre-wrap overflow-x-auto max-h-60 overflow-y-auto" 
                                                 id="task-output-{{ job.id }}-{{ task.task_order }}"
                                                 data-job-uuid="{{ job.job_uuid }}"
                                                 data-task-index="{{ task.task_order }}">
                                                <div class="text-gray-500 dark:text-gray-400">Connecting to live output...</div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div id="task-details-{{ job.id }}-{{ task.task_order }}" class="hidden mt-3 pt-3 border-t dark:border-gray-500">
                                            <div class="text-xs text-gray-500 dark:text-gray-400">No output available</div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                {# Simple job with single output #}
                {% set has_output = job.log_output and job.log_output.strip() %}
                {% if has_output %}
                    {% set escaped_output = job.log_output.strip() | e %}
                    <div class="mt-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100">Output:</h4>
                            <button onclick="copyJobOutput({{ job.id }})" class="text-sm text-blue-600 hover:text-blue-800">Copy</button>
                        </div>
                        <div class="bg-gray-900 text-green-400 p-3 rounded text-xs font-mono whitespace-pre-wrap overflow-x-auto max-h-60 overflow-y-auto" id="job-output-{{ job.id }}">{{ escaped_output }}</div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>