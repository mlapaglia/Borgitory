{% extends "base.html" %}

{% block content %}
<div x-data="borgitoryApp()" x-init="init()" class="space-y-8">
    <!-- Repository Selection -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Repository Management</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Repository Forms -->
            <div class="border rounded-lg p-4">
                <!-- Tabs -->
                <div class="flex mb-4 border-b">
                    <button onclick="switchRepositoryTab('create')" id="create-tab" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        Create New
                    </button>
                    <button onclick="switchRepositoryTab('import')" id="import-tab" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Import Existing
                    </button>
                </div>
                
                <!-- Create New Repository Form -->
                <div id="create-form" class="repository-form">
                    <h3 class="font-medium text-gray-700 mb-3">Create New Repository</h3>
                    <form 
                        hx-post="/api/repositories/" 
                        hx-ext="json-enc"
                        hx-target="#repository-list" 
                        hx-swap="beforeend"
                        hx-on::after-request="handleRepositoryResponse(event)"
                    >
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Path</label>
                                <input type="text" name="path" required placeholder="/repos/my-new-repo" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Passphrase</label>
                                <input type="password" name="passphrase" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Create Repository
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Import Existing Repository Form -->
                <div id="import-form" class="repository-form hidden">
                    <h3 class="font-medium text-gray-700 mb-3">Import Existing Repository</h3>
                    <div class="space-y-4">
                        <div class="flex space-x-2">
                            <button onclick="scanForRepositories()" class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700 text-sm">
                                Scan for Repositories
                            </button>
                            <div id="scan-status" class="flex items-center text-sm text-gray-500"></div>
                        </div>
                        
                        <div id="discovered-repos" class="hidden">
                            <label class="block text-sm font-medium text-gray-700">Found Repositories</label>
                            <select id="repo-select" onchange="selectDiscoveredRepo()" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select a repository...</option>
                            </select>
                        </div>
                        
                        <form 
                            hx-post="/api/repositories/import" 
                            hx-encoding="multipart/form-data"
                            hx-target="#repository-list" 
                            hx-swap="beforeend"
                            hx-on::before-request="handleImportStart(event)"
                            hx-on::after-request="handleImportResponse(event)"
                        >
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Name (for this app)</label>
                                    <input type="text" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Repository Path</label>
                                    <input type="text" name="path" id="import-path" required readonly class="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <!-- Encryption info display -->
                                <div id="encryption-info" class="hidden p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span id="encryption-text" class="text-sm text-blue-700"></span>
                                    </div>
                                </div>
                                
                                <!-- Passphrase field (always shown when repo selected) -->
                                <div id="passphrase-field" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Passphrase</label>
                                    <input type="password" name="passphrase" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <!-- Keyfile field (shown only for keyfile mode) -->
                                <div id="keyfile-field" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Keyfile</label>
                                    <input type="file" name="keyfile" accept=".key" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <p class="mt-1 text-sm text-gray-500">Upload the Borg keyfile (usually has .key extension)</p>
                                </div>
                                
                                <button type="submit" id="import-submit" disabled class="w-full bg-gray-400 text-white px-4 py-2 rounded-md cursor-not-allowed flex items-center justify-center">
                                    <span id="import-button-text">Select a repository first</span>
                                    <svg id="import-loading-spinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Repository List -->
            <div>
                <h3 class="font-medium text-gray-700 mb-3">Existing Repositories</h3>
                <div id="repository-list" hx-get="/api/repositories/" hx-trigger="load" hx-swap="innerHTML">
                    <div class="animate-pulse bg-gray-200 h-20 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Operations -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Backup Operations</h2>
        
        <!-- Tabs -->
        <div class="flex mb-6 border-b">
            <button onclick="switchBackupTab('manual')" id="manual-backup-tab" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                Manual Backup
            </button>
            <button onclick="switchBackupTab('scheduled')" id="scheduled-backup-tab" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                Scheduled Backup
            </button>
        </div>
        
        <!-- Manual Backup Tab -->
        <div id="manual-backup-form" class="backup-tab">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Manual Backup -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Create Backup</h3>
                <form 
                    hx-post="/api/jobs/backup" 
                    hx-ext="json-enc"
                    hx-target="#backup-status"
                    hx-on::after-request="handleBackupResponse(event)"
                >
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Repository</label>
                            <select name="repository_id" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Repository...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Source Path</label>
                            <input type="text" name="source_path" value="/data" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Compression</label>
                            <select name="compression" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="zstd">ZSTD (Recommended)</option>
                                <option value="lz4">LZ4 (Fast)</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="dry_run" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label class="ml-2 block text-sm text-gray-700">Dry Run</label>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            Start Backup
                        </button>
                    </div>
                </form>
                    <div id="backup-status" class="mt-4"></div>
                </div>

                <!-- Real-time Progress -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Current Operations</h3>
                    <div id="current-jobs" hx-get="/api/jobs/" hx-trigger="load, every 5s" hx-swap="innerHTML" hx-on::after-request="formatCurrentJobs(event)">
                        <div class="text-gray-500 text-sm">No active operations</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Scheduled Backup Tab -->
        <div id="scheduled-backup-form" class="backup-tab hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Create Schedule -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Create Schedule</h3>
                    <form 
                        hx-post="/api/schedules/" 
                        hx-ext="json-enc"
                        hx-target="#schedule-status"
                        hx-on::after-request="handleScheduleResponse(event)"
                    >
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" name="name" required placeholder="Daily backup" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Repository</label>
                                <select name="repository_id" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Repository...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Schedule</label>
                                <select onchange="updateCronExpression()" id="schedule-preset" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select a preset...</option>
                                    <option value="0 2 * * *">Daily at 2:00 AM</option>
                                    <option value="0 2 * * 0">Weekly on Sunday at 2:00 AM</option>
                                    <option value="0 2 1 * *">Monthly on 1st at 2:00 AM</option>
                                    <option value="0 2 1,15 * *">Twice monthly (1st and 15th) at 2:00 AM</option>
                                    <option value="0 2 */2 * *">Every 2 days at 2:00 AM</option>
                                    <option value="0 2 15-21 * 6">Third Saturday of month at 2:00 AM (approximation)</option>
                                    <option value="custom">Custom (cron expression)</option>
                                </select>
                            </div>
                            <div id="custom-cron" class="hidden">
                                <label class="block text-sm font-medium text-gray-700">Custom Cron Expression</label>
                                <input type="text" id="custom-cron-input" placeholder="0 2 * * *" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-sm text-gray-500">Format: minute hour day month weekday</p>
                            </div>
                            <input type="hidden" name="cron_expression" id="cron-expression">
                            <div id="cron-description" class="text-sm text-gray-600 bg-blue-50 p-2 rounded hidden"></div>
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                Create Schedule
                            </button>
                        </div>
                    </form>
                    <div id="schedule-status" class="mt-4"></div>
                </div>

                <!-- Existing Schedules -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Existing Schedules</h3>
                    <div id="schedules-list" 
                         hx-get="/api/schedules/html" 
                         hx-trigger="load, every 30s, scheduleUpdate from:body" 
                         hx-swap="innerHTML"
                         hx-indicator=".schedules-loading">
                        <div class="text-gray-500 text-sm">Loading schedules...</div>
                    </div>
                    <div class="schedules-loading htmx-indicator">
                        <div class="text-blue-500 text-sm">Updating schedules...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upcoming Scheduled Backups -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Upcoming Scheduled Backups</h2>
        <div id="upcoming-backups" 
             hx-get="/api/schedules/upcoming/html" 
             hx-trigger="load, every 60s, scheduleUpdate from:body" 
             hx-swap="innerHTML"
             hx-indicator=".upcoming-loading">
            <div class="text-gray-500 text-sm">Loading upcoming backups...</div>
        </div>
        <div class="upcoming-loading htmx-indicator">
            <div class="text-blue-500 text-sm">Updating upcoming backups...</div>
        </div>
    </div>

    <!-- Job History -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Job History</h2>
        <div id="job-history" hx-get="/api/jobs/" hx-trigger="load, every 10s" hx-swap="innerHTML" hx-on::after-request="formatJobHistory(event)">
            <div class="text-gray-500 text-sm">No job history</div>
        </div>
    </div>

    <!-- Archives -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Archives</h2>
        <div id="archives-list" class="overflow-x-auto">
            <div class="text-gray-500">Select a repository to view archives</div>
        </div>
    </div>
</div>

<script>
// Handle import repository start (loading state)
function handleImportStart(event) {
    const submitButton = document.getElementById('import-submit');
    const buttonText = document.getElementById('import-button-text');
    const spinner = document.getElementById('import-loading-spinner');
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.className = 'w-full bg-blue-400 text-white px-4 py-2 rounded-md cursor-not-allowed flex items-center justify-center';
    buttonText.textContent = 'Importing...';
    spinner.classList.remove('hidden');
}

// Handle import repository response
function handleImportResponse(event) {
    const xhr = event.detail.xhr;
    const form = event.target;
    const submitButton = document.getElementById('import-submit');
    const buttonText = document.getElementById('import-button-text');
    const spinner = document.getElementById('import-loading-spinner');
    
    // Hide loading state
    spinner.classList.add('hidden');
    buttonText.textContent = 'Import Repository';
    
    if (xhr.status >= 200 && xhr.status < 300) {
        // Success
        showNotification('Repository imported successfully!', 'success');
        form.reset();
        
        // Reset form state
        document.getElementById('encryption-info').classList.add('hidden');
        document.getElementById('passphrase-field').classList.add('hidden');
        document.getElementById('keyfile-field').classList.add('hidden');
        document.getElementById('repo-select').value = '';
        
        // Reset button to disabled state
        submitButton.disabled = true;
        submitButton.className = 'w-full bg-gray-400 text-white px-4 py-2 rounded-md cursor-not-allowed flex items-center justify-center';
        buttonText.textContent = 'Select a repository first';
        
        // Reload repositories for the dropdown
        window.borgitoryAppInstance?.loadRepositories();
    } else {
        // Error - re-enable button
        submitButton.disabled = false;
        submitButton.className = 'w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center justify-center';
        
        // Parse and show error message
        let errorMessage = 'Failed to import repository';
        try {
            const errorData = JSON.parse(xhr.response);
            if (errorData.detail) {
                if (Array.isArray(errorData.detail)) {
                    // Validation errors
                    errorMessage = errorData.detail.map(err => 
                        `${err.loc?.join('.')}: ${err.msg}`
                    ).join(', ');
                } else {
                    // String error message
                    errorMessage = errorData.detail;
                }
            }
        } catch (e) {
            // Fallback error message
            errorMessage = `HTTP ${xhr.status}: ${xhr.statusText}`;
        }
        showNotification(errorMessage, 'error');
    }
}

// Handle repository form response (for create form)
function handleRepositoryResponse(event) {
    const xhr = event.detail.xhr;
    const form = event.target;
    
    if (xhr.status >= 200 && xhr.status < 300) {
        // Success
        showNotification('Repository added successfully!', 'success');
        form.reset();
        // Reload repositories for the dropdown
        window.borgitoryAppInstance?.loadRepositories();
    } else {
        // Error
        let errorMessage = 'Failed to add repository';
        try {
            const errorData = JSON.parse(xhr.response);
            if (errorData.detail) {
                if (Array.isArray(errorData.detail)) {
                    // Validation errors
                    errorMessage = errorData.detail.map(err => 
                        `${err.loc?.join('.')}: ${err.msg}`
                    ).join(', ');
                } else {
                    // String error message
                    errorMessage = errorData.detail;
                }
            }
        } catch (e) {
            // Fallback error message
            errorMessage = `HTTP ${xhr.status}: ${xhr.statusText}`;
        }
        showNotification(errorMessage, 'error');
    }
}

// Handle backup form response
function handleBackupResponse(event) {
    const xhr = event.detail.xhr;
    const form = event.target;
    const statusDiv = document.getElementById('backup-status');
    
    if (xhr.status >= 200 && xhr.status < 300) {
        // Success - backup started
        try {
            const response = JSON.parse(xhr.response);
            showNotification('Backup started successfully!', 'success');
            statusDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                        <span class="text-blue-700 text-sm">Backup job #${response.job_id} started... (This may take a few minutes if Docker images need to be downloaded)</span>
                    </div>
                </div>
            `;
        } catch (e) {
            showNotification('Backup started!', 'success');
        }
    } else {
        // Error
        let errorMessage = 'Failed to start backup';
        try {
            const errorData = JSON.parse(xhr.response);
            if (errorData.detail) {
                if (Array.isArray(errorData.detail)) {
                    // Validation errors
                    errorMessage = errorData.detail.map(err => 
                        `${err.loc?.join('.')}: ${err.msg}`
                    ).join(', ');
                } else {
                    // String error message
                    errorMessage = errorData.detail;
                }
            }
        } catch (e) {
            // Fallback error message
            errorMessage = `HTTP ${xhr.status}: ${xhr.statusText}`;
        }
        showNotification(errorMessage, 'error');
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <span class="text-red-700 text-sm">${errorMessage}</span>
            </div>
        `;
    }
}

function borgitoryApp() {
    return {
        selectedRepository: null,
        repositories: [],
        
        init() {
            this.loadRepositories();
            // Store instance globally for form handler
            window.borgitoryAppInstance = this;
        },
        
        async loadRepositories() {
            try {
                const response = await fetch('/api/repositories/');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                this.repositories = await response.json();
                this.updateRepositorySelect();
            } catch (error) {
                showNotification('Failed to load repositories: ' + error.message, 'error');
            }
        },
        
        updateRepositorySelect() {
            const selects = document.querySelectorAll('select[name="repository_id"]');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Repository...</option>';
                this.repositories.forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo.id;
                    option.textContent = repo.name;
                    select.appendChild(option);
                });
            });
            
            // Also update the repository list display
            this.updateRepositoryList();
        },
        
        updateRepositoryList() {
            const container = document.getElementById('repository-list');
            if (!container) return;
            
            if (this.repositories.length === 0) {
                container.innerHTML = '<div class="text-gray-500 p-4">No repositories configured</div>';
                return;
            }
            
            container.innerHTML = this.repositories.map(repo => `
                <div class="flex items-center justify-between p-3 border rounded-lg mb-2">
                    <div>
                        <div class="font-medium">${repo.name}</div>
                        <div class="text-sm text-gray-500">${repo.path}</div>
                        <div class="text-xs text-gray-400">Created: ${new Date(repo.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="borgitoryAppInstance.selectRepository(${repo.id})" 
                                class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                            View Archives
                        </button>
                        <button onclick="borgitoryAppInstance.deleteRepository(${repo.id}, '${repo.name}')" 
                                class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        },
        
        async deleteRepository(id, name) {
            if (!confirm(`Are you sure you want to delete repository "${name}"? This will remove it from the database but not delete the actual Borg repository files.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/repositories/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification(`Repository "${name}" deleted successfully`, 'success');
                    await this.loadRepositories(); // Reload the list
                } else {
                    const error = await response.json();
                    showNotification(`Failed to delete repository: ${error.detail}`, 'error');
                }
            } catch (error) {
                showNotification(`Error deleting repository: ${error.message}`, 'error');
            }
        },
        
        selectRepository(id) {
            this.selectedRepository = id;
            this.loadArchives(id);
        },
        
        async loadArchives(repoId) {
            try {
                const response = await fetch(`/api/repositories/${repoId}/archives`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                this.displayArchives(data.archives);
            } catch (error) {
                showNotification('Failed to load archives: ' + error.message, 'error');
            }
        },
        
        displayArchives(archives) {
            const container = document.getElementById('archives-list');
            if (!container) return;
            
            if (archives.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No archives found</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${archives.map(archive => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${archive.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(archive.time).toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${this.formatBytes(archive.stats?.original_size || 0)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button onclick="borgitoryAppInstance.browseArchive(${this.selectedRepository}, '${archive.name}')" 
                                        class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    Browse Contents
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);
        },
        
        formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        async browseArchive(repoId, archiveName) {
            try {
                const response = await fetch(`/api/repositories/${repoId}/archives/${encodeURIComponent(archiveName)}/contents`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                this.displayArchiveContents(archiveName, data.contents);
            } catch (error) {
                showNotification(`Failed to load archive contents: ${error.message}`, 'error');
            }
        },
        
        displayArchiveContents(archiveName, contents) {
            const container = document.getElementById('archives-list');
            if (!container) return;
            
            if (contents.length === 0) {
                container.innerHTML = '<div class="text-gray-500">Archive is empty</div>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <div class="mb-4">
                    <button onclick="borgitoryAppInstance.loadArchives(${this.selectedRepository})" 
                            class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 mb-2">
                        ← Back to Archives
                    </button>
                    <h3 class="text-lg font-medium text-gray-900">Contents of "${archiveName}"</h3>
                </div>
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Path</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modified</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${contents.map(item => `
                        <tr>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900 break-all">${item.path}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.type || 'file'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${this.formatBytes(item.size || 0)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.mtime ? new Date(item.mtime).toLocaleString() : 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);
        },
        
        formatDuration(startDate, endDate) {
            if (!startDate || !endDate) return 'N/A';
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffMs = end - start;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const remainingSecs = diffSecs % 60;
            
            if (diffMins > 0) {
                return `${diffMins}m ${remainingSecs}s`;
            }
            return `${diffSecs}s`;
        },
        
        getStatusColor(status) {
            const colors = {
                'running': 'bg-blue-100 text-blue-700',
                'completed': 'bg-green-100 text-green-700', 
                'failed': 'bg-red-100 text-red-700',
                'pending': 'bg-yellow-100 text-yellow-700'
            };
            return colors[status] || 'bg-gray-100 text-gray-700';
        },
        
        toggleJobDetails(jobId) {
            const details = document.getElementById(`job-details-${jobId}`);
            const arrow = document.getElementById(`job-arrow-${jobId}`);
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                arrow.textContent = '▼';
            } else {
                details.classList.add('hidden');
                arrow.textContent = '▶';
            }
        },
        
        formatJsonValue(value) {
            if (value === null || value === undefined) return 'null';
            if (typeof value === 'string') return value;
            return JSON.stringify(value, null, 2);
        }
    }
}

// Repository tab management
function switchRepositoryTab(tab) {
    const createTab = document.getElementById('create-tab');
    const importTab = document.getElementById('import-tab');
    const createForm = document.getElementById('create-form');
    const importForm = document.getElementById('import-form');
    
    if (tab === 'create') {
        createTab.className = 'px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600';
        importTab.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        createForm.classList.remove('hidden');
        importForm.classList.add('hidden');
    } else {
        createTab.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        importTab.className = 'px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600';
        createForm.classList.add('hidden');
        importForm.classList.remove('hidden');
    }
}

// Repository scanning and import
let discoveredRepositories = [];

async function scanForRepositories() {
    const statusDiv = document.getElementById('scan-status');
    const discoveredDiv = document.getElementById('discovered-repos');
    const repoSelect = document.getElementById('repo-select');
    
    statusDiv.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600 mr-2"></div>Scanning...';
    
    try {
        const response = await fetch('/api/repositories/scan-existing');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        discoveredRepositories = data.repositories;
        
        if (discoveredRepositories.length === 0) {
            statusDiv.innerHTML = 'No new repositories found (all detected repositories are already imported)';
            discoveredDiv.classList.add('hidden');
        } else {
            statusDiv.innerHTML = `Found ${discoveredRepositories.length} new repository${discoveredRepositories.length === 1 ? '' : 's'} available for import`;
            
            // Populate select dropdown
            repoSelect.innerHTML = '<option value="">Select a repository...</option>';
            discoveredRepositories.forEach((repo, index) => {
                const option = document.createElement('option');
                option.value = index;
                const encryptionInfo = repo.encryption_mode ? ` (${repo.encryption_mode})` : '';
                const idInfo = repo.id ? ` [ID: ${repo.id.substring(0, 8)}...]` : '';
                option.textContent = `${repo.path}${encryptionInfo}${idInfo}`;
                repoSelect.appendChild(option);
            });
            
            discoveredDiv.classList.remove('hidden');
        }
    } catch (error) {
        statusDiv.innerHTML = `Error: ${error.message}`;
        console.error('Scan error:', error);
    }
}

function selectDiscoveredRepo() {
    const repoSelect = document.getElementById('repo-select');
    const pathInput = document.getElementById('import-path');
    const encryptionInfo = document.getElementById('encryption-info');
    const encryptionText = document.getElementById('encryption-text');
    const passphraseField = document.getElementById('passphrase-field');
    const keyfileField = document.getElementById('keyfile-field');
    const submitButton = document.getElementById('import-submit');
    const passphraseInput = document.querySelector('#import-form input[name="passphrase"]');
    const keyfileInput = document.querySelector('#import-form input[name="keyfile"]');
    
    const selectedIndex = repoSelect.value;
    if (selectedIndex !== '') {
        const repo = discoveredRepositories[parseInt(selectedIndex)];
        pathInput.value = repo.path;
        
        // Auto-suggest a name based on the path
        const nameInput = document.querySelector('#import-form input[name="name"]');
        if (!nameInput.value) {
            const pathParts = repo.path.split('/');
            const suggestedName = pathParts[pathParts.length - 1] || 'imported-repo';
            nameInput.value = suggestedName;
        }
        
        // Show encryption information
        const encryptionMode = repo.encryption_mode || 'unknown';
        const requiresKeyfile = repo.requires_keyfile || false;
        
        encryptionInfo.classList.remove('hidden');
        if (requiresKeyfile) {
            encryptionText.textContent = `This repository uses keyfile encryption. You'll need both the passphrase and the keyfile to access it.`;
        } else if (encryptionMode === 'repokey') {
            encryptionText.textContent = `This repository uses repokey encryption. Only the passphrase is required.`;
        } else {
            encryptionText.textContent = `This repository uses ${encryptionMode} encryption.`;
        }
        
        // Always show passphrase field
        passphraseField.classList.remove('hidden');
        passphraseInput.required = true;
        
        // Show keyfile field only if required
        if (requiresKeyfile) {
            keyfileField.classList.remove('hidden');
            keyfileInput.required = true;
        } else {
            keyfileField.classList.add('hidden');
            keyfileInput.required = false;
        }
        
        // Enable submit button
        submitButton.disabled = false;
        document.getElementById('import-button-text').textContent = 'Import Repository';
        submitButton.className = 'w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center justify-center';
    } else {
        // Hide all fields and disable submit
        pathInput.value = '';
        encryptionInfo.classList.add('hidden');
        passphraseField.classList.add('hidden');
        keyfileField.classList.add('hidden');
        
        passphraseInput.required = false;
        keyfileInput.required = false;
        
        submitButton.disabled = true;
        document.getElementById('import-button-text').textContent = 'Select a repository first';
        submitButton.className = 'w-full bg-gray-400 text-white px-4 py-2 rounded-md cursor-not-allowed flex items-center justify-center';
    }
}

// Global functions for HTMX callbacks
function formatCurrentJobs(event) {
    const container = document.getElementById('current-jobs');
    if (!container) return;
    
    try {
        const jobs = JSON.parse(event.detail.xhr.response);
        const runningJobs = jobs.filter(job => job.status === 'running' || job.status === 'pending');
        
        if (runningJobs.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-sm">No active operations</div>';
            return;
        }
        
        container.innerHTML = runningJobs.map(job => `
            <div class="flex items-center justify-between p-3 border rounded-lg mb-2">
                <div>
                    <div class="font-medium">Job #${job.id} - ${job.type}</div>
                    <div class="text-sm text-gray-500">
                        <span class="inline-flex px-2 py-1 text-xs rounded-full ${borgitoryAppInstance.getStatusColor(job.status)}">${job.status}</span>
                        ${job.started_at ? 'Started: ' + new Date(job.started_at).toLocaleString() : ''}
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="borgitoryAppInstance.toggleJobDetails(${job.id})" 
                            class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                        <span id="job-arrow-${job.id}">▶</span> Details
                    </button>
                </div>
            </div>
            <div id="job-details-${job.id}" class="hidden bg-gray-50 p-4 rounded-lg mb-2 ml-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>Container ID:</strong> <code class="text-xs">${job.container_id || 'N/A'}</code></div>
                    <div><strong>Repository:</strong> ${job.repository_id}</div>
                    <div><strong>Started:</strong> ${job.started_at ? new Date(job.started_at).toLocaleString() : 'N/A'}</div>
                    <div><strong>Duration:</strong> ${borgitoryAppInstance.formatDuration(job.started_at, new Date())}</div>
                </div>
                ${job.error ? `<div class="mt-2"><strong>Error:</strong><pre class="text-xs bg-red-50 p-2 rounded mt-1">${job.error}</pre></div>` : ''}
                ${job.log_output ? `<div class="mt-2"><strong>Logs:</strong><pre class="text-xs bg-white p-2 rounded mt-1 max-h-32 overflow-y-auto">${job.log_output}</pre></div>` : ''}
            </div>
        `).join('');
    } catch (e) {
        console.error('Error formatting current jobs:', e);
    }
}

function formatJobHistory(event) {
    const container = document.getElementById('job-history');
    if (!container) return;
    
    try {
        const jobs = JSON.parse(event.detail.xhr.response);
        
        if (jobs.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-sm">No job history</div>';
            return;
        }
        
        container.innerHTML = jobs.map(job => `
            <div class="flex items-center justify-between p-3 border rounded-lg mb-2">
                <div>
                    <div class="font-medium">Job #${job.id} - ${job.type}</div>
                    <div class="text-sm text-gray-500">
                        <span class="inline-flex px-2 py-1 text-xs rounded-full ${borgitoryAppInstance.getStatusColor(job.status)}">${job.status}</span>
                        ${job.started_at ? 'Started: ' + new Date(job.started_at).toLocaleString() : ''}
                        ${job.finished_at ? ' | Duration: ' + borgitoryAppInstance.formatDuration(job.started_at, job.finished_at) : ''}
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="borgitoryAppInstance.toggleJobDetails(${job.id})" 
                            class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                        <span id="job-arrow-${job.id}">▶</span> Details
                    </button>
                </div>
            </div>
            <div id="job-details-${job.id}" class="hidden bg-gray-50 p-4 rounded-lg mb-2 ml-4">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>Container ID:</strong> <code class="text-xs">${job.container_id || 'N/A'}</code></div>
                    <div><strong>Repository:</strong> ${job.repository_id}</div>
                    <div><strong>Started:</strong> ${job.started_at ? new Date(job.started_at).toLocaleString() : 'N/A'}</div>
                    <div><strong>Finished:</strong> ${job.finished_at ? new Date(job.finished_at).toLocaleString() : 'N/A'}</div>
                </div>
                ${job.error ? `<div class="mt-2"><strong>Error:</strong><pre class="text-xs bg-red-50 p-2 rounded mt-1">${job.error}</pre></div>` : ''}
                ${job.log_output ? `<div class="mt-2"><strong>Logs:</strong><pre class="text-xs bg-white p-2 rounded mt-1 max-h-64 overflow-y-auto">${job.log_output}</pre></div>` : ''}
            </div>
        `).join('');
    } catch (e) {
        console.error('Error formatting job history:', e);
    }
}

// Backup tab management
function switchBackupTab(tab) {
    const manualTab = document.getElementById('manual-backup-tab');
    const scheduledTab = document.getElementById('scheduled-backup-tab');
    const manualForm = document.getElementById('manual-backup-form');
    const scheduledForm = document.getElementById('scheduled-backup-form');
    
    if (tab === 'manual') {
        manualTab.className = 'px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600';
        scheduledTab.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        manualForm.classList.remove('hidden');
        scheduledForm.classList.add('hidden');
    } else {
        manualTab.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700';
        scheduledTab.className = 'px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600';
        manualForm.classList.add('hidden');
        scheduledForm.classList.remove('hidden');
    }
}

// Schedule management functions
function updateCronExpression() {
    const preset = document.getElementById('schedule-preset');
    const customCron = document.getElementById('custom-cron');
    const customInput = document.getElementById('custom-cron-input');
    const cronExpression = document.getElementById('cron-expression');
    const cronDescription = document.getElementById('cron-description');
    
    if (preset.value === 'custom') {
        customCron.classList.remove('hidden');
        cronExpression.value = customInput.value;
    } else if (preset.value) {
        customCron.classList.add('hidden');
        cronExpression.value = preset.value;
        
        // Show human-readable description
        const descriptions = {
            '0 2 * * *': 'Runs daily at 2:00 AM',
            '0 2 * * 0': 'Runs weekly on Sundays at 2:00 AM',
            '0 2 1 * *': 'Runs monthly on the 1st at 2:00 AM',
            '0 2 1,15 * *': 'Runs twice monthly (1st and 15th) at 2:00 AM',
            '0 2 */2 * *': 'Runs every 2 days at 2:00 AM',
            '0 2 15-21 * 6': 'Runs on the third Saturday of each month at 2:00 AM (15th-21st, Saturday only)'
        };
        
        if (descriptions[preset.value]) {
            cronDescription.textContent = descriptions[preset.value];
            cronDescription.classList.remove('hidden');
        } else {
            cronDescription.classList.add('hidden');
        }
    } else {
        customCron.classList.add('hidden');
        cronExpression.value = '';
        cronDescription.classList.add('hidden');
    }
}

// Handle custom cron input changes
document.addEventListener('DOMContentLoaded', function() {
    const customInput = document.getElementById('custom-cron-input');
    if (customInput) {
        customInput.addEventListener('input', function() {
            const cronExpression = document.getElementById('cron-expression');
            cronExpression.value = this.value;
        });
    }
});

// Handle schedule form response
function handleScheduleResponse(event) {
    const xhr = event.detail.xhr;
    const form = event.target;
    const statusDiv = document.getElementById('schedule-status');
    
    if (xhr.status >= 200 && xhr.status < 300) {
        // Success
        showNotification('Schedule created successfully!', 'success');
        form.reset();
        document.getElementById('cron-description').classList.add('hidden');
        statusDiv.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                <span class="text-green-700 text-sm">Schedule created and activated</span>
            </div>
        `;
        
        // Trigger custom event to refresh all schedule-related sections
        document.body.dispatchEvent(new CustomEvent('scheduleUpdate'));
    } else {
        // Error
        let errorMessage = 'Failed to create schedule';
        try {
            const errorData = JSON.parse(xhr.response);
            if (errorData.detail) {
                errorMessage = Array.isArray(errorData.detail) 
                    ? errorData.detail.map(err => `${err.loc?.join('.')}: ${err.msg}`).join(', ')
                    : errorData.detail;
            }
        } catch (e) {
            errorMessage = `HTTP ${xhr.status}: ${xhr.statusText}`;
        }
        showNotification(errorMessage, 'error');
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <span class="text-red-700 text-sm">${errorMessage}</span>
            </div>
        `;
    }
}

// Note: Formatting now handled by backend HTML endpoints

// Helper function to format time until next run
function formatTimeUntil(milliseconds) {
    if (milliseconds < 0) return 'Overdue';
    
    const seconds = Math.floor(milliseconds / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        const remainingHours = hours % 24;
        return `${days}d ${remainingHours}h`;
    } else if (hours > 0) {
        const remainingMinutes = minutes % 60;
        return `${hours}h ${remainingMinutes}m`;
    } else if (minutes > 0) {
        const remainingSeconds = seconds % 60;
        return `${minutes}m ${remainingSeconds}s`;
    } else {
        return `${seconds}s`;
    }
}

// Schedule management actions
async function toggleSchedule(scheduleId) {
    try {
        const response = await fetch(`/api/schedules/${scheduleId}/toggle`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification(data.message, 'success');
            
            // Trigger custom event to refresh all schedule-related sections
            document.body.dispatchEvent(new CustomEvent('scheduleUpdate'));
        } else {
            const error = await response.json();
            showNotification(`Failed to toggle schedule: ${error.detail}`, 'error');
        }
    } catch (error) {
        showNotification(`Error toggling schedule: ${error.message}`, 'error');
    }
}

async function deleteSchedule(scheduleId, scheduleName) {
    if (!confirm(`Are you sure you want to delete the schedule "${scheduleName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/schedules/${scheduleId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            const data = await response.json();
            showNotification(data.message, 'success');
            
            // Trigger custom event to refresh all schedule-related sections
            document.body.dispatchEvent(new CustomEvent('scheduleUpdate'));
        } else {
            const error = await response.json();
            showNotification(`Failed to delete schedule: ${error.detail}`, 'error');
        }
    } catch (error) {
        showNotification(`Error deleting schedule: ${error.message}`, 'error');
    }
}
</script>
{% endblock %}