name: Release

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

env:
  REGISTRY: docker.io
  IMAGE_NAME: mlapaglia/borgitory

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
    - name: Extract version
      id: version
      run: |
        VERSION=${{ github.event.release.tag_name }}
        # Remove 'v' prefix if present
        VERSION=${VERSION#v}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Extracted version: ${VERSION}"

  pypi-release:
    runs-on: ${{ matrix.os }}
    needs: prepare-release
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
          - os: ubuntu-latest
            arch: aarch64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 2

    - name: Set up QEMU for ARM64 emulation
      if: matrix.arch == 'aarch64'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Python (x86_64)
      if: matrix.arch == 'x86_64'
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Update pyproject.toml version
      uses: jacobtomlinson/gha-find-replace@v3
      with:
        find: 'version = ".*"'
        replace: 'version = "${{ needs.prepare-release.outputs.version }}"'
        regex: true
        include: "pyproject.toml"

    - name: Install build dependencies (x86_64)
      if: matrix.arch == 'x86_64'
      run: |
        python -m pip install --upgrade pip
        python -m pip install build

    - name: Build package (x86_64)
      if: matrix.arch == 'x86_64'
      run: python -m build

    - name: Build package (ARM64)
      if: matrix.arch == 'aarch64'
      run: |
        docker run --rm --platform linux/arm64 \
          -v $(pwd):/workspace \
          -w /workspace \
          python:3.11-slim \
          bash -c "
            apt-get update && \
            apt-get install -y --no-install-recommends gcc pkg-config libfuse3-dev && \
            python -m pip install --upgrade pip build && \
            python -m build
          "

    - name: Publish to PyPI
      if: github.event.release.prerelease == false
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true

    - name: Publish to TestPyPI
      if: github.event.release.prerelease == true
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        print-hash: true

  docker-release:
    runs-on: ubuntu-latest
    needs: prepare-release

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}

    - name: Update pyproject.toml version
      uses: jacobtomlinson/gha-find-replace@v3
      with:
        find: 'version = ".*"'
        replace: 'version = "${{ needs.prepare-release.outputs.version }}"'
        regex: true
        include: "pyproject.toml"

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          # For stable releases: tag with version and latest
          type=raw,value=${{ needs.prepare-release.outputs.version }},enable=${{ github.event.release.prerelease == false }}
          type=raw,value=latest,enable=${{ github.event.release.prerelease == false }}
          # For prereleases: tag with exact version and alpha
          type=raw,value=${{ needs.prepare-release.outputs.version }},enable=${{ github.event.release.prerelease == true }}
          type=raw,value=alpha,enable=${{ github.event.release.prerelease == true }}
        labels: |
          org.opencontainers.image.title=Borgitory
          org.opencontainers.image.description=A comprehensive web-based management interface for BorgBackup repositories with real-time monitoring, automated scheduling, and cloud synchronization capabilities
          org.opencontainers.image.version=${{ needs.prepare-release.outputs.version }}
          org.opencontainers.image.url=https://github.com/mlapaglia/borgitory
          org.opencontainers.image.source=https://github.com/mlapaglia/borgitory
          org.opencontainers.image.vendor=mlapaglia
          org.opencontainers.image.licenses=MIT

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ needs.prepare-release.outputs.version }}
          BORGITORY_VERSION=${{ needs.prepare-release.outputs.version }}

    - name: Update Docker Hub description
      if: always()
      uses: peter-evans/dockerhub-description@v4
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_PASSWORD }}
        repository: ${{ env.IMAGE_NAME }}
        readme-filepath: ./README.md